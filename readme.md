

## 1. 数据存储与导入

本次所使用的数据主要来自于两个表：某种药物的发货数据、药物的交易数据。药物共有两种，分别记为编号 5 和 6 。在本次实验中，由于药物 5 和 6 仅仅是类别不同，并且药物 5 的交易记录更多，因此我们选用了药物 5 的记录作为本实验的数据来源。

药物 5 的原始交易数据为 csv 格式，共有 3935274 条交易数据，总大小 1.1GB。在导入的过程中，我们尝试了使用关系型数据库（PostgresQL）存储和图数据库（Neo4j）存储。经过比较，关系型数据库总体上更加适合用作后端存储和分析的数据库，因为导入占用的时间空间都较少，并且主要的需求是一些数据统计，对于复杂图查询的需求不高。

后端数据库主要有一个表，为 `sale5` （表示交易记录），其构建表结构语句位于 `backend/sql/sale5.sql` ，其中一些重要的字段如下：

| 字段名                             | 类型        | 含义                     |
| ---------------------------------- | ----------- | ------------------------ |
| `sale_date`                        | `timestamp` | 交易日期                 |
| `seller_code_ph`                   | `varchar`   | 卖方的编码（唯一标识符） |
| `seller_agent_historical_level`    | `varchar`   | 卖方的等级               |
| `seller_agent_business_area_small` | `varchar`   | 卖方所在商务区           |
| `seller_province`                  | `varchar`   | 卖方所在省               |
| `seller_city`                      | `varchar`   | 卖方所在市               |
| `purchaser_business_area`          | `varchar`   | 买方所在商务区           |
| `purchaser_code_ph`                | `varchar`   | 买方的编码（唯一标识符） |
| `purchaser_province`               | `varchar`   | 买方所在省               |
| `purchaser_city`                   | `varchar`   | 买方所在市               |
| `purchaser_property`               | `varchar`   | 买方的类型               |
| `batch_number`                     | `varchar`   | 药品批次                 |
| `sale_amount_factory`              | `decimal`   | 交易金额                 |

其中商务区的概念指几个省组成的一个区，如 `North-东北` 、 `South-粤桂琼` 等；买方的类型分为两种：经销商与终端，其中终端又有药店和医院两种，而卖方一定是经销商；经销商的等级从高到低分为 `Tier 1, Tier 2, Tier 3` 三种。也就是说，存在经销商向经销商卖出药物，或者经销商向终端卖出药物，经销商之间往往按等级从高到低进行药物的交易，但是也存在同级经销商之间、上下级经销商之间调货的情况，但不存在终端卖给经销商的情况。

为便于查询处理，在导入数据后又创建了若干物化视图、对一些属性建立了索引。具体的实现位于 `backend/data_import.py` 和 `backend/db_conn.py` 中。



## 2. 风险检测方法

对于本实验中的数据，我们经过分析认为，风险意味着存在数据有问题的经销商，从经销商角度来看，可能存在以下两种风险：

1. 经销商为了掩盖问题，故意漏报、误报、多报交易额；
2. 经销商为了“业绩”（即销量要求），制造不存在的交易。

这些风险体现在交易记录中，可能存在以下三种现象：

1. 某个经销商自己向自己发货，以制造虚假的交易额；
2. 多于一个经销商之间循环相互调货，以制造虚假的交易额；
3. 某个经销商总进货量不等于总出货量，可能漏报或误报导致的。

实验中我们对于交易记录中的这几种现象进行了检测。结果表明，第三种现象检测的错误率较高，具体来说是假阳性率比较高，因为部分交易记录的小数点位数可能有偏差（例如经销商 A 买入了金额为 596.0 的某批次药物，卖出了金额为 5960 的同一批药物），不太可信，因此主要阐述实验中对前两种现象的检测。

我们将前两种现象的检测作为图论问题解决。在图 $G=(V,E)$ 中，$v \in V$ 表示一个经销商， $e \in E = (v_i, v_j)$ 表示由经销商 $v_i$ 卖给经销商 $v_j$ 的一条**有向**边（本问题不涉及终端），其药物批号为 $e.batch$ 。

经销商自己向自己发货定义为：求 $C_1 = \{v ~|~ \exists e=(v, v) \in E\}$  

多个经销商之间循环调货定义为：求 $C_2 = \{v ~|~ \exists p=(v_0,v_1,v_2,\cdots,v_m), v_0 = v_m = v, e_i=(v_i, v_{i+1}) \in E, e_i.batch = e_j.batch, \forall i,j\}$ 

设所有交易记录构成的图 $G$ 的对应邻接矩阵为 $A$ ，则 $A \in \mathbb{R}^{|V| \times |V|}$ ，$A_{ij} = \begin{cases} 1, e=(v_i, v_j) \in E \\ 0, \text{other.} \end{cases}$ 。

$C_1$ 可以通过求解所有满足 $A_{ii} = 1$ 的 $i$ 得到。

对于 $C_2$ ，我们应当将每种不同批号的边所联结的结点各自作为一个子图，在每个子图中检查是否有 $C_2$ 中定义的结点存在。即构造一个子图 $G^\prime=(V^\prime,E^\prime, batch)$ ，其中 $V^\prime \subseteq V, E^\prime \subseteq E$ ，且 $\forall e \in E, e.batch=batch \Leftrightarrow e \in E^\prime$ 。在这个子图中如果存在长度大于1的环，则出现了 $C_2$ 情况。

对于环的检测转化为对邻接矩阵的检测。如果一个结点在**有向**环中，则一定存在一条路径可以使从该结点出发，经有限步回到自身。在一个大小为 $|V^\prime|$ 的图中，则最多 $|V^\prime|$ 步。因此，问题可通过寻找“经过 $k < |V^\prime|$ 步能够到达自身”的结点。计算邻接矩阵的幂 $A^{|V^\prime|}_{ii} > 0$ 即可。在实现过程中为加速使用了快速幂算法。

风险检测算法实现位于 `backend/algorithm.py` 。



## 3. 数据前端可视化与交互实现

### 3.1 实现明细

* 采用的可视化框架：Echart.js
* 编程语言：html、js、css
* 详细：可视化采用的主要基础组件包括：echart中的geo、geo3d，并在此之上，使用line、scatter、3dBar、visualMap等组件，实现了流向图、柱状图、热力图等具体的数据展现形式，通过重写echart中鼠标监听事件完成用户交互。

### 3.2 可视化布局

##### 药品流向数据

* 数据展示形式：2d流向图

  在2d的地理地图上，使用原点标出药品经销商的具体位置，使用曲线与流动动画表示药品的买卖方向，展示整个药品在进销商网络中随时间进行的流动过程

  需要用户输入

  * 药品批号
  * 开始经销商身份

* 交互：

  * 在鼠标移至原点上时，使用移动窗口的方式展示经销商或的具体信息（进销商的唯一身份ID）。
  * 在鼠标移至线条上时，使用移动窗口的方式展示药品买卖的具体信息（买卖方的身份ID与本次买卖的具体金额）。
  * 用户可以手动在右侧调节当前所显示的药品记录的事件范围，也可选择自动播放类型，让地图中的买卖记录随着时间流动自行变化。

<img src="C:/main/work/2020Autumn/InfoVis/DrugVIs/Visualization/image/image-20201221012902207.png" alt="image-20201221012902207" style="zoom: 50%;" />

##### 药品销售统计

* 数据展示形式：3d柱状图

  在3d的地理地图上，使用高度与销量相关的柱状图展示不同区域在某个时段中对于某批次药物的销售情况，采用了不同的颜色大小表示经销商的不同等级。

  需要用户输入：

  * 药品批号
  * 统计时段

* 交互

  * 用户可以通过右侧区域选择列表，选择展示某个特定的省份中，不同城市对于某款药品的销售情况
  * 也可以点击返回按钮，查看全国的所有省份，对于某款药品的销售情况
  * 鼠标移至柱状图上时，会显示对应区域的具体销售情况

<img src="C:/main/work/2020Autumn/InfoVis/DrugVIs/Visualization/image/image-20201221013306377.png" alt="image-20201221013306377" style="zoom:50%;" />

##### 区域风险估计

* 数据展示形式：2d热力地图

  在2d的地理图上，根据不同区域的风险数值，采用不同的颜色标注不同的区域 ， 展示不同区域的药物销售风险大小。

* 交互

  * 用户点击某个省份时，会显示对应省份中不同城市的风险程度。

<img src="C:/main/work/2020Autumn/InfoVis/DrugVIs/Visualization/image/image-20201221013015055.png" alt="image-20201221013015055" style="zoom: 50%;" />

##### 经销商风险买卖检测

* 数据展示形式：2d流向图

  在2d流向图中，使用原点标出药品经销商的具体位置，使用曲线与流动动画表示药品的买卖方向，展示某一批药物的全部流通过程中，可能的经销商违规流通操作，全部显示的经销商均为红色，以不同的大小区分经销商的级别。

  需要用户输入：

  * 药品批号

* 交互

  * 鼠标移至原点上时，使用移动窗口的方式展示经销商或的具体信息（进销商的唯一身份ID）。
  * 在鼠标移至线条上时，使用移动窗口的方式展示药品买卖的具体信息（买卖方的身份ID与本次买卖的具体金额）。
  * 用户可以手动在右侧调节当前所显示的药品记录的事件范围，也可选择自动播放类型，让地图中的买卖记录随着时间流动自行变化。

<img src="C:/main/work/2020Autumn/InfoVis/DrugVIs/Visualization/image/image-20201221013056615.png" alt="image-20201221013056615" style="zoom:50%;" />

##### 区域销量预测

* 数据展现形式：2d地图与2d折线图

  通过在2d地图上让用户选择不同的区域，在折线图中展示未来给定区域的预测销售情况

* 交互：

  * 鼠标点击对应区域，在折线图中显示对应区域的未来销量预测
  * 用户可以通过右侧的选择框，选择预测区域的大小
  